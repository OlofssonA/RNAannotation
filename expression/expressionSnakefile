include:"pipeline.conf"

rule all:
       input: ResultDirIDX+"/expression.txt"

rule expression_contig:
        input: expand(ResultDirIDX+"/{sample}.sorted.idxstats",sample = SAMPLE)
        output: ResultDirIDX+"/expression.txt"
        shell: "awk '{{mapped[FNR]+=$3; contigid[FNR]= $1; seqlen[FNR]= $2}} END{{for(i=1;i<=FNR-1;i++) print contigid[i], (mapped[i]/(ARGC-1))/seqlen[i];}}' {ResultDirIDX}/* > {output}"

rule idxstats:
        input: ResultDirNoHit+"/{sample}.sort.bam", ResultDirNoHit+"/{sample}.sort.bam.bai"
        output: ResultDirIDX+"/{sample}.sorted.idxstats"
        shell: "samtools idxstats {input} > {output}"

rule indexbam:
        input: ResultDirNoHit+"/{sample}.sort.bam"
        output: ResultDirNoHit+"/{sample}.sort.bam.bai"
        shell: "samtools index {input}"

rule sortbam:
        input: ResultDirNoHit+"/{sample}.bam"
        output: ResultDirNoHit+"/{sample}.sort.bam"
        shell: "samtools sort {input} {ResultDirNoHit}/{wildcards.sample}.sort"

rule sam2bam:
        input: ResultDirNoHit+"/{sample}.sam"
        output: ResultDirNoHit+"/{sample}.bam"
        shell: "samtools view -bSh -o {output} {input}"

rule run_bowtie2_mapping:
        input: ReadsDir+"/{sample}.fastq"
        output: ResultDirNoHit+"/{sample}.noHIT.1.fastq", ResultDirNoHit+"/{sample}.noHIT.2.fastq", ResultDirNoHit+"/{sample}.sam"
        threads: 16
        shell: "bowtie2 --threads 16 -x {REFfile} -1 -U {input} --un-conc {ResultDirNoHit}/{wildcards.sample}.noHIT.fastq -S {ResultDirNoHit}/{wildcards.sample}.sam"

